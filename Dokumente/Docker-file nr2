version: "3.8"

services:
  database:
    # Datenbank-Service-Konfiguration (MariaDB)
    build: ./mysql_m169
    networks:
      - m169
    command: --init-file /docker-entrypoint-initdb.d/moodle_dump.sql
    environment:
      MYSQL_DATABASE: moodle
      MYSQL_USER: moodle
      MYSQL_PASSWORD_FILE: /run/secrets/mysql_password
      MYSQL_ROOT_PASSWORD: /run/secrets/mysql_root_password 
    secrets:
     - mysql_password
     - mysql_root_password
     # Verwendung der Secrets "mysql_password" und "mysql_root_password" im Datenbank-Service.
     # Das Secret "mysql_password" enthält das Passwort für den MySQL-Benutzer "moodle".
     # Das Secret "mysql_root_password" enthält das Root-Passwort für die Datenbank.

    volumes:
      - /compose:/docker-entrypoint-initdb.d/moodle_dump.sql
      - /data_m169/dbdata:/var/lib/mysql
      # Verbindet den Host-Pfad './moodle_dump' mit dem Container-Pfad '/docker-entrypoint-initdb.d/moodle.sql'.
      # Verbindet den Host-Pfad '/data_m169/dbdata' mit dem Container-Pfad '/var/lib/mysql'.
      # Dies ermöglicht das Speichern von Datenbank-spezifischen Daten außerhalb des Containers.

  moodle:
    # Moodle-Service-Konfiguration
    build: ./moodle_m169
    networks:
      - m169
    ports:
      - 80:80
      # Port-Mapping: Der Host-Port 80 wird auf den Container-Port 80 gemappt.
      # Dadurch wird der Moodle-Service über den Host-Port 80 erreichbar.

    depends_on:
      - database
    environment:
      MOODLE_DATABASE_TYPE: mysqli
      MOODLE_DATABASE_HOST: compose_database_1
      MOODLE_DATABASE_NAME: moodle
      MOODLE_DATABSE_USER: moodle
      MOODLE_DATABASE_PASSWORD: /run/secrets/mysql_password

    secrets:
      - mysql_password
      # Verwendung des Secrets "mysql_password" im Moodle-Service.
      # Das Secret enthält das Passwort für den MySQL-Benutzer "moodle".

    volumes:
      - /data_m169/moodledata:/var/www/html/moodledata
      # Verbindet den Host-Pfad '/data_m169/moodledata' mit dem Container-Pfad '/var/www/html/moodledata'.
      # Dies ermöglicht das Speichern von Moodle-spezifischen Daten außerhalb des Containers.

secrets:
  # Secrets-Konfiguration
  mysql_password:
    file: ./secrets/mysql_password.txt
    # Das Secret "mysql_password" wird aus der Datei './secrets/mysql_password.txt' geladen.
    # Diese Datei enthält das Passwort für den MySQL-Benutzer "moodle".

  mysql_root_password:
    file: ./secrets/mysql_root_password.txt
    # Das Secret "mysql_root_password" wird aus der Datei './secrets/mysql_root_password.txt' geladen.
    # Diese Datei enthält das Root-Passwort für die Datenbank.

volumes:
  # Volumes-Konfiguration
  moodledata:
  dbdata:
  compose:


networks:
  m169:

